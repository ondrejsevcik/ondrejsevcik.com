<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="" />
    <title>
      How to merge git repository into monorepo - Ondrej Sevcik
    </title>

    <link rel="stylesheet" href="/styles.css">
  </head>
  <body>
    <div class="header">
      <h1>
        <a href="/">home</a>
      </h1>
    </div>

    <div>
      <header>
    <h1>
      How to merge git repository into monorepo
    </h1>
    <div class="post-meta">
      <time datetime="">
        2019-08-23
      </time>
    </div>
</header>

<article>
  <p>Merging two unrelated git repositories into one might look like an ambitious task, but once you understand what’s happening, you will find out it’s pretty simple.</p>
<h2 id="What-we-are-about-to-do"><a href="#What-we-are-about-to-do" class="headerlink" title="What we are about to do"></a>What we are about to do</h2><p>In this article, we will merge a git repository into monorepo. The example is demonstrated on a <a href="https://yarnpkg.com/en/docs/workspaces/" target="_blank" rel="noopener">yarn workspace</a> (which is a bunch of npm packages in one repository) and one npm package that should be merged into it. This is a common setup for a lot of front-end projects out there.</p>
<p>We start with two git repositories (monorepo and packageC) and end up with just monorepo, that will contain git history and all files from packageC.</p>
<p>Beware: This technique doesn’t allow you to merge tags from packageC.</p>
<figure>
  <a href="/images/git-folders-before-after.png"><img src="/images/git-folders-before-after.png" alt="Folder structure before and after merge"></a>
  <figcaption>Folder structure before and after merge</figcaption>
</figure>

<p>TIP: If you don’t want to keep history, it’s way simpler to just copy files to the new repository and make a commit (KISS).</p>
<h2 id="Step-by-step"><a href="#Step-by-step" class="headerlink" title="Step by step"></a>Step by step</h2><h3 id="1-Clone-source-repository"><a href="#1-Clone-source-repository" class="headerlink" title="1. Clone source repository"></a>1. Clone source repository</h3><p>Even if you already have a copy of your source repository, I recommend making a new one. There will be changes and if something goes wrong, it’s easier to just delete and start over rather than trying to undo the changes (unless you know git very well).</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">## Replace packageC with your folder name</span></span><br><span class="line">git <span class="built_in">clone</span> &lt;repo-url&gt; packageC</span><br></pre></td></tr></table></figure>

<h2 id="2-Move-all-files-into-packages-sub-directory"><a href="#2-Move-all-files-into-packages-sub-directory" class="headerlink" title="2. Move all files into packages/* sub-directory"></a>2. Move all files into packages/* sub-directory</h2><p>Moving all files in a source repository into <code>packages</code> sub-directory will make your life easier. You will avoid conflicts when you later merge it into monorepo. Also, certain operations in your monorepo will become easier (e.g.: finding renames, making a diff based on a file path).</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># The --prune-empty - removes commits which are empty due to the rewrite</span></span><br><span class="line"><span class="built_in">export</span> TARGET_DIR=<span class="string">"packages/packageC"</span></span><br><span class="line">git filter-branch --prune-empty --tree-filter <span class="string">'</span></span><br><span class="line"><span class="string">  mkdir -p "$TARGET_DIR"</span></span><br><span class="line"><span class="string">  git ls-tree --name-only $GIT_COMMIT | xargs -I files mv files "$TARGET_DIR"</span></span><br><span class="line"><span class="string">'</span></span><br></pre></td></tr></table></figure>

<p>Since now, the history will be rewritten as if all files were always located in <code>packages/packageC</code> folder.</p>
<p>BTW: With <code>git filter-branch</code> you can also extract package out of monorepo back into a single repository, but that’s a topic for another article.</p>
<h3 id="3-Merge-into-monorepo"><a href="#3-Merge-into-monorepo" class="headerlink" title="3. Merge into monorepo"></a>3. Merge into monorepo</h3><p>Now everything is ready to be merged. But before we do so, I will shortly explain what is this <code>git merge --allow-unrelated-histories</code> flag about.</p>
<p>By default, git won’t allow you to merge branch that doesn’t have a common ancestor. With this flag, we’re telling git that we know about it and that this merge is deliberate.</p>
<p>Git repository is always created with an initial commit, but in this case, we don’t have any. Our monorepo and packageC were created separately and thus have separate initial commits. To fix this, git will pretend that there was an empty initial commit that’s common for those unrelated histories. You can read more about it in the <a href="https://git-scm.com/docs/git-merge#Documentation/git-merge.txt---allow-unrelated-histories" target="_blank" rel="noopener">official documentation</a>.</p>
<figure style="max-width: 24rem; margin:auto;">
  <a href="/images/git-history-before-after-merge.png"><img src="/images/git-history-before-after-merge.png" alt="Git history before and after merge"></a>
  <figcaption>Git history before and after merge</figcaption>
</figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Add remote in your monorepo to packageC</span></span><br><span class="line">git remote add packageC ~/git/packageC</span><br><span class="line"></span><br><span class="line"><span class="comment"># Fetch commits from packageC</span></span><br><span class="line"><span class="comment"># --no-tags - do not fetch tags, otherwise they will pollute your tags in current monorepo</span></span><br><span class="line">git fetch packageC --no-tags</span><br><span class="line"></span><br><span class="line"><span class="comment"># Merge</span></span><br><span class="line">git merge packageC/master --allow-unrelated-histories</span><br><span class="line"></span><br><span class="line"><span class="comment"># Remove remote</span></span><br><span class="line">git remote remove packageC</span><br></pre></td></tr></table></figure>

<h3 id="4-Clean-up"><a href="#4-Clean-up" class="headerlink" title="4. Clean up"></a>4. Clean up</h3><p>After a successful merge, it’s time for cleanup. Remove duplicate config files (<code>.editorconfig</code>, <code>.eslint</code>, …), delete old repository and fix your CI build.</p>

</article>

    </div>

    <div class="footer">
      <div class="copyright">
        &copy; 2019 Ondrej Sevcik
      </div>
    </div>
  </body>
</html>
